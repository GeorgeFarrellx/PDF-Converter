name: CI Parser Specific Fixtures

on:
  push:
    branches: [main]
  pull_request:

jobs:
  test-parser-specific-fixtures:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - run: python -m pip install -U pip
      - run: pip install reportlab pdfplumber

      - name: Run unittest and capture log
        id: unittest
        shell: bash
        run: |
          set +e
          python -m unittest discover -s tests -p "test_*.py" 2>&1 | tee unittest.log
          test_exit=${PIPESTATUS[0]}
          echo "exit_code=$test_exit" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Build compact summary from unittest log
        if: always()
        run: python scripts/ci_summarize_unittest.py unittest.log > ci_parser_fixture_summary.md

      - name: Publish compact summary
        if: always()
        shell: bash
        run: cat ci_parser_fixture_summary.md >> "$GITHUB_STEP_SUMMARY"

      - name: Upload unittest outputs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: parser-specific-fixtures-unittest
          if-no-files-found: warn
          path: |
            unittest.log
            ci_parser_fixture_summary.md

      - name: Fail job if unittest failed
        if: steps.unittest.outputs.exit_code != '0'
        run: |
          echo "Unittest failed with exit code ${{ steps.unittest.outputs.exit_code }}"
          exit 1
